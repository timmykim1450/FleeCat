# Î°úÍ∑∏Ïù∏ API ÌÖåÏä§Ìä∏ Î¨∏ÏÑú

**ÏûëÏÑ±Ïùº**: 2025-10-02
**API ÏóîÎìúÌè¨Ïù∏Ìä∏**: `POST /api/v1/auth/login`
**ÌÖåÏä§Ìä∏ ÎåÄÏÉÅ**: ÌöåÏõê Î°úÍ∑∏Ïù∏ Î∞è JWT ÌÜ†ÌÅ∞ Î∞úÍ∏â

---

## üìã Î™©Ï∞®

1. [API ÏÇ¨Ïñë](#api-ÏÇ¨Ïñë)
2. [ÌÖåÏä§Ìä∏ Í≥ºÏ†ïÏóêÏÑú Î∞úÏÉùÌïú Ïò§Î•ò](#ÌÖåÏä§Ìä∏-Í≥ºÏ†ïÏóêÏÑú-Î∞úÏÉùÌïú-Ïò§Î•ò)
3. [ÏΩîÎìú ÏàòÏ†ï ÏÇ¨Ìï≠](#ÏΩîÎìú-ÏàòÏ†ï-ÏÇ¨Ìï≠)
4. [ÌÖåÏä§Ìä∏ Í≤∞Í≥º](#ÌÖåÏä§Ìä∏-Í≤∞Í≥º)
5. [Î¨∏Ï†ú Ìï¥Í≤∞ ÏöîÏïΩ](#Î¨∏Ï†ú-Ìï¥Í≤∞-ÏöîÏïΩ)

---

## API ÏÇ¨Ïñë

### Endpoint
```
POST http://localhost:3000/api/v1/auth/login
```

### Headers
```
Content-Type: application/json
```

### Request Body
```json
{
  "email": "buyer1@example.com",
  "password": "Password123!"
}
```

### Success Response (200 OK)
```json
{
  "success": true,
  "message": "Login successful",
  "data": {
    "member": {
      "member_id": 3,
      "company_id": null,
      "member_email": "buyer1@example.com",
      "member_name": "Hong Gildong",
      "member_nickname": "gildong",
      "member_phone": "010-1111-1111",
      "member_account_type": "individual",
      "member_account_role": "buyer",
      "member_status": "active",
      "member_marketing_email": false,
      "member_marketing_sms": false,
      "member_last_login_at": null,
      "member_created_at": "2025-10-02T03:43:33.139Z",
      "member_updated_at": "2025-10-02T03:43:33.139Z",
      "role": "buyer",
      "roles": ["buyer"]
    },
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
  }
}
```

---

## ÌÖåÏä§Ìä∏ Í≥ºÏ†ïÏóêÏÑú Î∞úÏÉùÌïú Ïò§Î•ò

### Ïò§Î•ò 1: `member_permission` ÌïÑÎìú Ï°¥Ïû¨ÌïòÏßÄ ÏïäÏùå

**Î∞úÏÉù ÏãúÏ†ê**: Ï≤´ Î≤àÏß∏ Î°úÍ∑∏Ïù∏ ÏãúÎèÑ

**Ïò§Î•ò Î©îÏãúÏßÄ**:
```
Unknown field `member_permission` for include statement on model `Member`.
Available options are marked with ?: member_addresses?, member_permissions?, ...
```

**ÏõêÏù∏**:
`src/repositories/member.repository.js`Ïùò `findByEmail()` Ìï®ÏàòÏóêÏÑú ÏûòÎ™ªÎêú relation Ïù¥Î¶Ñ ÏÇ¨Ïö©
- SchemaÏóêÏÑúÎäî `member_permissions` (Î≥µÏàòÌòï)Ïù∏Îç∞ ÏΩîÎìúÏóêÏÑúÎäî `member_permission` (Îã®ÏàòÌòï) ÏÇ¨Ïö©

**Ìï¥Í≤∞ Î∞©Î≤ï**:
`src/repositories/member.repository.js:18,37` ÏàòÏ†ï
```javascript
// Î≥ÄÍ≤Ω Ï†Ñ
include: {
  member_permission: true,  // ‚ùå ÏûòÎ™ªÎêú ÌïÑÎìúÎ™Ö
  company: true
}

// Î≥ÄÍ≤Ω ÌõÑ
include: {
  member_permissions: true,  // ‚úÖ Ïò¨Î∞îÎ•∏ ÌïÑÎìúÎ™Ö
  company: true
}
```

---

### Ïò§Î•ò 2: BigInt ÏßÅÎ†¨Ìôî Ïò§Î•ò

**Î∞úÏÉù ÏãúÏ†ê**: `member_permission` ÌïÑÎìúÎ™Ö ÏàòÏ†ï ÌõÑ Î°úÍ∑∏Ïù∏ ÏãúÎèÑ

**Ïò§Î•ò Î©îÏãúÏßÄ**:
```
TypeError: Do not know how to serialize a BigInt
```

**ÏõêÏù∏**:
- PrismaÏóêÏÑú Î∞òÌôòÌïú `member_permissions`ÏôÄ `company` Í∞ùÏ≤¥Ïóê BigInt ÌÉÄÏûÖÏù¥ Ìè¨Ìï®Îê®
- ExpressÏùò `res.json()`Ïù¥ BigIntÎ•º ÏßÅÎ†¨ÌôîÌïòÏßÄ Î™ªÌï®

**Ìï¥Í≤∞ Î∞©Î≤ï**:
`src/services/auth.service.js:154` - ÏùëÎãµÏóêÏÑú relation Í∞ùÏ≤¥ Ï†úÏô∏

```javascript
// Î≥ÄÍ≤Ω Ï†Ñ
const { member_password, ...memberData } = member;

return {
  member: {
    ...memberData,  // member_permissions, companyÍ∞Ä Ìè¨Ìï®ÎêòÏñ¥ BigInt ÏßÅÎ†¨Ìôî Ïò§Î•ò Î∞úÏÉù
    member_id: Number(memberData.member_id),
    company_id: memberData.company_id ? Number(memberData.company_id) : null,
    role: primaryRole,
    roles: allRoles
  },
  token
};

// Î≥ÄÍ≤Ω ÌõÑ
const { member_password, member_permissions, company, ...memberData } = member;

return {
  member: {
    ...memberData,  // relation Í∞ùÏ≤¥ Ï†úÏô∏ÌïòÏó¨ BigInt ÏßÅÎ†¨Ìôî Ïò§Î•ò Î∞©ÏßÄ
    member_id: Number(memberData.member_id),
    company_id: memberData.company_id ? Number(memberData.company_id) : null,
    role: primaryRole,
    roles: allRoles
  },
  token
};
```

---

### Ïò§Î•ò 3: `roles` Î∞∞Ïó¥Ïù¥ `[null]`Î°ú Î∞òÌôòÎê®

**Î∞úÏÉù ÏãúÏ†ê**: BigInt ÏßÅÎ†¨Ìôî Ïò§Î•ò Ìï¥Í≤∞ ÌõÑ Î°úÍ∑∏Ïù∏ ÏãúÎèÑ

**ÏùëÎãµ Í≤∞Í≥º**:
```json
{
  "member": {
    "role": "buyer",
    "roles": [null]  // ‚ùå null Î∞òÌôò
  }
}
```

**ÏõêÏù∏**:
- `memberPermission.repository.js`Ïùò `getRoles()`ÏôÄ `getPrimaryRole()` Ìï®ÏàòÍ∞Ä Int ‚Üí String Î≥ÄÌôòÏùÑ ÌïòÏßÄ ÏïäÏùå
- DatabaseÏóêÎäî `member_permission_role`Ïù¥ Int ÌÉÄÏûÖ(1, 2, 3)ÏúºÎ°ú Ï†ÄÏû•Îê®
- ÏΩîÎìúÏóêÏÑúÎäî String ÌÉÄÏûÖ("buyer", "seller", "admin")ÏùÑ Í∏∞ÎåÄÌï®

**Ìï¥Í≤∞ Î∞©Î≤ï**:
`src/repositories/memberPermission.repository.js` - Îëê Ìï®ÏàòÏóê roleMap Î≥ÄÌôò Î°úÏßÅ Ï∂îÍ∞Ä

#### 1) `getPrimaryRole()` ÏàòÏ†ï (74-93Î≤àÏß∏ Ï§Ñ)

```javascript
// Î≥ÄÍ≤Ω Ï†Ñ
async function getPrimaryRole(memberId) {
  try {
    const permissions = await findByMemberId(memberId);

    if (permissions.length === 0) {
      return 'buyer';
    }

    const roles = permissions.map(p => p.permission_role);  // ‚ùå ÌïÑÎìúÎ™ÖÎèÑ ÏûòÎ™ªÎê®

    if (roles.includes('seller')) return 'seller';
    if (roles.includes('admin')) return 'admin';
    return 'buyer';
  } catch (error) {
    throw new Error(`Failed to get primary role: ${error.message}`);
  }
}

// Î≥ÄÍ≤Ω ÌõÑ
async function getPrimaryRole(memberId) {
  try {
    const permissions = await findByMemberId(memberId);

    if (permissions.length === 0) {
      return 'buyer'; // Í∏∞Î≥∏Í∞í
    }

    // ‚úÖ Int ‚Üí String Î≥ÄÌôò: 1=buyer, 2=seller, 3=admin
    const roleMap = { 1: 'buyer', 2: 'seller', 3: 'admin' };
    const roles = permissions.map(p => roleMap[p.member_permission_role] || 'buyer');

    // Ïö∞ÏÑ†ÏàúÏúÑ: seller > admin > buyer
    if (roles.includes('seller')) return 'seller';
    if (roles.includes('admin')) return 'admin';
    return 'buyer';
  } catch (error) {
    throw new Error(`Failed to get primary role: ${error.message}`);
  }
}
```

#### 2) `getRoles()` ÏàòÏ†ï (100-109Î≤àÏß∏ Ï§Ñ)

```javascript
// Î≥ÄÍ≤Ω Ï†Ñ
async function getRoles(memberId) {
  try {
    const permissions = await findByMemberId(memberId);
    return permissions.map(p => p.permission_role);  // ‚ùå ÌïÑÎìúÎ™ÖÎèÑ ÏûòÎ™ªÎê®
  } catch (error) {
    throw new Error(`Failed to get roles: ${error.message}`);
  }
}

// Î≥ÄÍ≤Ω ÌõÑ
async function getRoles(memberId) {
  try {
    const permissions = await findByMemberId(memberId);
    // ‚úÖ Int ‚Üí String Î≥ÄÌôò: 1=buyer, 2=seller, 3=admin
    const roleMap = { 1: 'buyer', 2: 'seller', 3: 'admin' };
    return permissions.map(p => roleMap[p.member_permission_role] || 'buyer');
  } catch (error) {
    throw new Error(`Failed to get roles: ${error.message}`);
  }
}
```

---

## ÏΩîÎìú ÏàòÏ†ï ÏÇ¨Ìï≠

### 1. `src/repositories/member.repository.js`

**ÌååÏùº ÏúÑÏπò**: `src/repositories/member.repository.js`

**ÏàòÏ†ï ÎùºÏù∏**: 18, 37

**Î≥ÄÍ≤Ω ÎÇ¥Ïö©**:
- `member_permission` ‚Üí `member_permissions` (Î≥µÏàòÌòï)
- Prisma relation Ïù¥Î¶ÑÏùÑ SchemaÏôÄ ÏùºÏπòÏãúÌÇ¥

```javascript
// findById() - 18Î≤àÏß∏ Ï§Ñ
include: {
  member_permissions: true,  // ‚úÖ ÏàòÏ†ï
  company: true
}

// findByEmail() - 37Î≤àÏß∏ Ï§Ñ
include: {
  member_permissions: true,  // ‚úÖ ÏàòÏ†ï
  company: true
}
```

---

### 2. `src/services/auth.service.js`

**ÌååÏùº ÏúÑÏπò**: `src/services/auth.service.js`

**ÏàòÏ†ï ÎùºÏù∏**: 154

**Î≥ÄÍ≤Ω ÎÇ¥Ïö©**:
- ÏùëÎãµ Í∞ùÏ≤¥ÏóêÏÑú `member_permissions`, `company` relation Ï†úÏô∏
- BigInt ÏßÅÎ†¨Ìôî Ïò§Î•ò Î∞©ÏßÄ

```javascript
// 6. ÎπÑÎ∞ÄÎ≤àÌò∏ Î∞è Í¥ÄÍ≥Ñ Îç∞Ïù¥ÌÑ∞ Ï†úÏô∏ÌïòÍ≥† Î∞òÌôò
const { member_password, member_permissions, company, ...memberData } = member;

return {
  member: {
    ...memberData,
    member_id: Number(memberData.member_id),
    company_id: memberData.company_id ? Number(memberData.company_id) : null,
    role: primaryRole,
    roles: allRoles
  },
  token
};
```

---

### 3. `src/repositories/memberPermission.repository.js`

**ÌååÏùº ÏúÑÏπò**: `src/repositories/memberPermission.repository.js`

**ÏàòÏ†ï Ìï®Ïàò**: `getPrimaryRole()`, `getRoles()`

**Î≥ÄÍ≤Ω ÎÇ¥Ïö©**:
- Int ÌÉÄÏûÖ role Í∞íÏùÑ String ÌÉÄÏûÖÏúºÎ°ú Î≥ÄÌôòÌïòÎäî roleMap Ï∂îÍ∞Ä
- Database Ï†ÄÏû•Í∞í: 1=buyer, 2=seller, 3=admin

#### `getPrimaryRole()` ÏàòÏ†ï (74-93Î≤àÏß∏ Ï§Ñ)

```javascript
async function getPrimaryRole(memberId) {
  try {
    const permissions = await findByMemberId(memberId);

    if (permissions.length === 0) {
      return 'buyer'; // Í∏∞Î≥∏Í∞í
    }

    // ‚úÖ Int ‚Üí String Î≥ÄÌôò
    const roleMap = { 1: 'buyer', 2: 'seller', 3: 'admin' };
    const roles = permissions.map(p => roleMap[p.member_permission_role] || 'buyer');

    // Ïö∞ÏÑ†ÏàúÏúÑ: seller > admin > buyer
    if (roles.includes('seller')) return 'seller';
    if (roles.includes('admin')) return 'admin';
    return 'buyer';
  } catch (error) {
    throw new Error(`Failed to get primary role: ${error.message}`);
  }
}
```

#### `getRoles()` ÏàòÏ†ï (100-109Î≤àÏß∏ Ï§Ñ)

```javascript
async function getRoles(memberId) {
  try {
    const permissions = await findByMemberId(memberId);
    // ‚úÖ Int ‚Üí String Î≥ÄÌôò
    const roleMap = { 1: 'buyer', 2: 'seller', 3: 'admin' };
    return permissions.map(p => roleMap[p.member_permission_role] || 'buyer');
  } catch (error) {
    throw new Error(`Failed to get roles: ${error.message}`);
  }
}
```

---

## ÌÖåÏä§Ìä∏ Í≤∞Í≥º

### ÌÖåÏä§Ìä∏ ÏºÄÏù¥Ïä§ 1: buyer1 Í≥ÑÏ†ï Î°úÍ∑∏Ïù∏

**ÏöîÏ≤≠**:
```bash
curl -X POST http://localhost:3000/api/v1/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email":"buyer1@example.com","password":"Password123!"}'
```

**ÏùëÎãµ (200 OK)**:
```json
{
  "success": true,
  "message": "Login successful",
  "data": {
    "member": {
      "member_id": 3,
      "company_id": null,
      "member_email": "buyer1@example.com",
      "member_name": "Hong Gildong",
      "member_nickname": "gildong",
      "member_phone": "010-1111-1111",
      "member_account_type": "individual",
      "member_account_role": "buyer",
      "member_status": "active",
      "member_marketing_email": false,
      "member_marketing_sms": false,
      "member_last_login_at": null,
      "member_created_at": "2025-10-02T03:43:33.139Z",
      "member_updated_at": "2025-10-02T03:43:33.139Z",
      "role": "buyer",
      "roles": ["buyer"]
    },
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJtZW1iZXJfaWQiOjMsImVtYWlsIjoiYnV5ZXIxQGV4YW1wbGUuY29tIiwicm9sZSI6ImJ1eWVyIiwicm9sZXMiOlsiYnV5ZXIiXSwiaWF0IjoxNzU5MzgwMTAzLCJleHAiOjE3NTk5ODQ5MDN9.LBZ5MuGFaQiPklM9-7WIIy8CUTjasvnxfwDDttBDtO0"
  }
}
```

**Í≤ÄÏ¶ù**:
- ‚úÖ HTTP ÏÉÅÌÉú ÏΩîÎìú: 200
- ‚úÖ `role`: "buyer"
- ‚úÖ `roles`: ["buyer"] (Ïù¥Ï†Ñ [null] Î¨∏Ï†ú Ìï¥Í≤∞Îê®)
- ‚úÖ JWT ÌÜ†ÌÅ∞ Ï†ïÏÉÅ Î∞úÍ∏â
- ‚úÖ BigInt ÏßÅÎ†¨Ìôî Ïò§Î•ò ÏóÜÏùå
- ‚úÖ Î™®Îì† ÌïÑÎìú Ï†ïÏÉÅ Î∞òÌôò

---

## Î¨∏Ï†ú Ìï¥Í≤∞ ÏöîÏïΩ

| Ïò§Î•ò | ÏõêÏù∏ | Ìï¥Í≤∞ Î∞©Î≤ï | ÏàòÏ†ï ÌååÏùº |
|------|------|-----------|----------|
| Unknown field `member_permission` | Prisma relation Ïù¥Î¶Ñ Î∂àÏùºÏπò (Îã®Ïàò/Î≥µÏàò) | `member_permission` ‚Üí `member_permissions` | `member.repository.js:18,37` |
| BigInt ÏßÅÎ†¨Ìôî Ïò§Î•ò | relation Í∞ùÏ≤¥Ïóê BigInt Ìè¨Ìï® | ÏùëÎãµÏóêÏÑú `member_permissions`, `company` Ï†úÏô∏ | `auth.service.js:154` |
| `roles: [null]` Î∞òÌôò | Int ‚Üí String Î≥ÄÌôò Î°úÏßÅ ÎàÑÎùΩ | roleMap Ï∂îÍ∞Ä (1‚Üíbuyer, 2‚Üíseller, 3‚Üíadmin) | `memberPermission.repository.js:74-93, 100-109` |

---

## JWT ÌÜ†ÌÅ∞ Í≤ÄÏ¶ù

**ÌÜ†ÌÅ∞ Payload (ÎîîÏΩîÎî© Í≤∞Í≥º)**:
```json
{
  "member_id": 3,
  "email": "buyer1@example.com",
  "role": "buyer",
  "roles": ["buyer"],
  "iat": 1759380103,
  "exp": 1759984903
}
```

**Í≤ÄÏ¶ù ÎÇ¥Ïö©**:
- ‚úÖ `member_id`: Ï†ïÏÉÅ (3)
- ‚úÖ `email`: Ï†ïÏÉÅ
- ‚úÖ `role`: "buyer" (primaryRole)
- ‚úÖ `roles`: ["buyer"] (Î™®Îì† Ïó≠Ìï† Î∞∞Ïó¥)
- ‚úÖ `iat` (Î∞úÍ∏â ÏãúÍ∞Ñ): 2025-10-02 12:41:43 (UTC)
- ‚úÖ `exp` (ÎßåÎ£å ÏãúÍ∞Ñ): 2025-10-09 12:41:43 (UTC) - 7Ïùº ÌõÑ

---

## Ï∂îÍ∞Ä ÌÖåÏä§Ìä∏ ÌïÑÏöî Ìï≠Î™©

### 1. Îã§Î•∏ Í≥ÑÏ†ï Î°úÍ∑∏Ïù∏ ÌÖåÏä§Ìä∏
- [ ] buyer2@example.com
- [ ] buyer3@example.com
- [ ] seller@example.com
- [ ] admin@example.com

### 2. ÏóêÎü¨ ÏºÄÏù¥Ïä§ ÌÖåÏä§Ìä∏
- [ ] ÏûòÎ™ªÎêú Ïù¥Î©îÏùº (Ï°¥Ïû¨ÌïòÏßÄ ÏïäÎäî Í≥ÑÏ†ï)
- [ ] ÏûòÎ™ªÎêú ÎπÑÎ∞ÄÎ≤àÌò∏
- [ ] Ïù¥Î©îÏùº ÎàÑÎùΩ
- [ ] ÎπÑÎ∞ÄÎ≤àÌò∏ ÎàÑÎùΩ
- [ ] ÎπÑÌôúÏÑ±ÌôîÎêú Í≥ÑÏ†ï (`member_status: 'inactive'`)

### 3. JWT ÌÜ†ÌÅ∞ Í≤ÄÏ¶ù ÌÖåÏä§Ìä∏
- [ ] ÌÜ†ÌÅ∞ÏúºÎ°ú Ïù∏Ï¶ùÏù¥ ÌïÑÏöîÌïú API Ìò∏Ï∂ú
- [ ] ÎßåÎ£åÎêú ÌÜ†ÌÅ∞ Ï≤òÎ¶¨
- [ ] ÏûòÎ™ªÎêú ÌòïÏãùÏùò ÌÜ†ÌÅ∞ Ï≤òÎ¶¨

---

## Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ ÌôïÏù∏ ÏøºÎ¶¨

### Î°úÍ∑∏Ïù∏Ìïú ÌöåÏõê Ï†ïÎ≥¥ ÌôïÏù∏
```sql
SELECT
  m.member_id,
  m.member_email,
  m.member_name,
  m.member_nickname,
  mp.member_permission_role
FROM member m
LEFT JOIN member_permissions mp ON m.member_id = mp.member_id
WHERE m.member_email = 'buyer1@example.com';
```

**Í≤∞Í≥º**:
| member_id | member_email | member_name | member_nickname | member_permission_role |
|-----------|--------------|-------------|-----------------|------------------------|
| 3 | buyer1@example.com | Hong Gildong | gildong | 1 |

**Ìï¥ÏÑù**:
- `member_permission_role = 1` ‚Üí "buyer"
- roleMap Î≥ÄÌôòÏù¥ Ï†ïÏÉÅÏ†ÅÏúºÎ°ú ÏûëÎèôÌï®

---

## Ï∞∏Í≥†ÏÇ¨Ìï≠

### Role Îß§Ìïë Í∑úÏπô

**Database Ï†ÄÏû•Í∞í (Int)**:
- `1` = buyer (Íµ¨Îß§Ïûê)
- `2` = seller (ÌåêÎß§Ïûê)
- `3` = admin (Í¥ÄÎ¶¨Ïûê)

**API ÏùëÎãµÍ∞í (String)**:
- `"buyer"` = Íµ¨Îß§Ïûê
- `"seller"` = ÌåêÎß§Ïûê
- `"admin"` = Í¥ÄÎ¶¨Ïûê

### Primary Role Ïö∞ÏÑ†ÏàúÏúÑ

ÌïòÎÇòÏùò ÌöåÏõêÏù¥ Ïó¨Îü¨ Ïó≠Ìï†ÏùÑ Í∞ÄÏßà Îïå, Primary Role Í≤∞Ï†ï Ïö∞ÏÑ†ÏàúÏúÑ:
1. `seller` (ÏµúÏö∞ÏÑ†)
2. `admin`
3. `buyer` (Í∏∞Î≥∏Í∞í)

**ÏòàÏãú**:
- buyer + seller ‚Üí Primary Role: **seller**
- buyer + admin ‚Üí Primary Role: **admin**
- buyer + seller + admin ‚Üí Primary Role: **seller**

---

**ÏûëÏóÖ ÏôÑÎ£åÏùº**: 2025-10-02
**ÏÉÅÌÉú**: ‚úÖ Î™®Îì† Ïò§Î•ò ÏàòÏ†ï ÏôÑÎ£å, ÌÖåÏä§Ìä∏ ÏÑ±Í≥µ
