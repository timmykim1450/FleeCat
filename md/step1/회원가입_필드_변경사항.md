# íšŒì›ê°€ì… API í•„ë“œ ë³€ê²½ì‚¬í•­

**ì‘ì„±ì¼**: 2025-10-02
**ì‘ì—… ë‚´ìš©**: íšŒì›ê°€ì… ì‹œ ì´ë¦„ í•„ë“œ ì¶”ê°€ ë° ìŠ¤í‚¤ë§ˆ ìˆ˜ì •

---

## ğŸ“‹ ë³€ê²½ ìš”ì•½

íšŒì›ê°€ì… APIì— **ì´ë¦„(name)** í•„ë“œë¥¼ í•„ìˆ˜ë¡œ ì¶”ê°€í•˜ê³ , íœ´ëŒ€í° ë²ˆí˜¸ëŠ” ì„ íƒì‚¬í•­ìœ¼ë¡œ ìœ ì§€í–ˆìŠµë‹ˆë‹¤.

### ì£¼ìš” ë³€ê²½ì‚¬í•­
1. âœ… `member_name` í•„ë“œ ì¶”ê°€ (í•„ìˆ˜)
2. âœ… `member_phone` í•„ë“œ ì„ íƒì‚¬í•­ìœ¼ë¡œ ë³€ê²½
3. âœ… `member_account_type` ê¸°ë³¸ê°’ "email" ì„¤ì •
4. âœ… í…Œì´ë¸”ëª… `members` â†’ `member`ë¡œ ë³€ê²½

---

## ğŸ—„ï¸ ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ ë³€ê²½

### 1. Prisma Schema ìˆ˜ì •

**íŒŒì¼**: `prisma/schema.prisma`

```prisma
model Member {
  member_id              BigInt    @id @default(autoincrement())
  company_id             BigInt?
  member_email           String    @unique @db.VarChar(100)
  member_password        String?   @db.VarChar(255)
  member_name            String    @db.VarChar(30)           // âœ… ì¶”ê°€: í•„ìˆ˜
  member_nickname        String    @unique @db.VarChar(30)
  member_phone           String?   @db.VarChar(15)           // âœ… ë³€ê²½: ì„ íƒì‚¬í•­ (String?)
  member_account_type    String    @default("email") @db.VarChar(20) // âœ… ê¸°ë³¸ê°’ ì¶”ê°€
  member_account_role    String    @default("buyer") @db.VarChar(20)
  member_status          String    @default("active") @db.VarChar(20)
  member_marketing_email Boolean   @default(false)
  member_marketing_sms   Boolean   @default(false)
  member_last_login_at   DateTime?
  member_created_at      DateTime  @default(now())
  member_updated_at      DateTime  @default(now()) @updatedAt

  @@map("member")  // âœ… í…Œì´ë¸”ëª… ë³€ê²½: members â†’ member
}
```

### 2. ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰

```bash
# 1ì°¨ ë§ˆì´ê·¸ë ˆì´ì…˜: í…Œì´ë¸”ëª… ë³€ê²½
npx prisma migrate dev --name rename_members_to_member

# 2ì°¨ ë§ˆì´ê·¸ë ˆì´ì…˜: í•„ë“œ ì¶”ê°€/ìˆ˜ì •
npx prisma migrate dev --name add_name_and_optional_phone
```

**ìƒì„±ëœ ë§ˆì´ê·¸ë ˆì´ì…˜ íŒŒì¼**:
- `20251002015915_rename_members_to_member/migration.sql`
- `20251002021051_add_name_and_optional_phone/migration.sql`

---

## ğŸ’» ì½”ë“œ ë³€ê²½ì‚¬í•­

### 1. Validation ë¯¸ë“¤ì›¨ì–´

**íŒŒì¼**: `src/middlewares/validation.js`

```javascript
const validateRegister = [
  body('email')
    .notEmpty()
    .withMessage('Email is required')
    .isEmail()
    .withMessage('Invalid email format')
    .isLength({ max: 255 })
    .withMessage('Email must not exceed 255 characters')
    .normalizeEmail(),

  body('password')
    .notEmpty()
    .withMessage('Password is required')
    .isLength({ min: 8 })
    .withMessage('Password must be at least 8 characters')
    .matches(/^(?=.*[A-Za-z])(?=.*\d)/)
    .withMessage('Password must contain at least one letter and one number'),

  // âœ… ì¶”ê°€: name í•„ë“œ ê²€ì¦
  body('name')
    .notEmpty()
    .withMessage('Name is required')
    .isLength({ min: 2, max: 30 })
    .withMessage('Name must be between 2 and 30 characters')
    .trim(),

  body('nickname')
    .notEmpty()
    .withMessage('Nickname is required')
    .isLength({ min: 2, max: 20 })
    .withMessage('Nickname must be between 2 and 20 characters')
    .matches(/^[a-zA-Z0-9ê°€-í£]+$/)
    .withMessage('Nickname can only contain letters, numbers, and Korean characters')
    .trim(),

  body('phone')
    .optional({ checkFalsy: true })  // âœ… ìœ ì§€: ì„ íƒì‚¬í•­
    .matches(/^01[0-9]-?[0-9]{3,4}-?[0-9]{4}$/)
    .withMessage('Invalid phone number format (e.g., 010-1234-5678 or 01012345678)')
    .trim(),

  handleValidationErrors
];
```

### 2. Controller

**íŒŒì¼**: `src/controllers/auth.controller.js`

```javascript
async function register(req, res, next) {
  try {
    // âœ… ì¶”ê°€: name íŒŒë¼ë¯¸í„° ì¶”ì¶œ
    const { email, password, name, nickname, phone } = req.body;

    const result = await authService.register({
      email,
      password,
      name,      // âœ… ì¶”ê°€
      nickname,
      phone
    });

    return successResponse(res, result, 'Registration successful', 201);
  } catch (error) {
    next(error);
  }
}
```

### 3. Service

**íŒŒì¼**: `src/services/auth.service.js`

```javascript
async function register(data) {
  const { email, password, name, nickname, phone } = data;  // âœ… name ì¶”ê°€

  // 1. ì´ë©”ì¼ ì¤‘ë³µ í™•ì¸
  const emailExists = await memberRepository.existsByEmail(email);
  if (emailExists) {
    throw new ValidationError('Email already exists');
  }

  // 2. ë‹‰ë„¤ì„ ì¤‘ë³µ í™•ì¸
  const nicknameExists = await memberRepository.existsByNickname(nickname);
  if (nicknameExists) {
    throw new ValidationError('Nickname already exists');
  }

  // 3. ë¹„ë°€ë²ˆí˜¸ í•´ì‹±
  const hashedPassword = await bcrypt.hash(password, 10);

  // 4. íšŒì› ìƒì„±
  const member = await memberRepository.create({
    member_email: email,
    member_password: hashedPassword,
    member_name: name,          // âœ… ì¶”ê°€
    member_nickname: nickname,
    member_phone: phone || null,
    member_status: 'active'
  });

  // ... ê¶Œí•œ ë¶€ì—¬ ë° í† í° ìƒì„±
}
```

### 4. Repository

**íŒŒì¼**: `src/repositories/member.repository.js`

```javascript
async function create(memberData) {
  try {
    return await prisma.member.create({
      data: {
        member_email: memberData.member_email,
        member_password: memberData.member_password,
        member_name: memberData.member_name,          // âœ… ì¶”ê°€
        member_nickname: memberData.member_nickname,
        member_phone: memberData.member_phone || null,
        member_status: memberData.member_status || 'active',
        company_id: memberData.company_id ? BigInt(memberData.company_id) : null
      }
    });
  } catch (error) {
    throw new Error(`Failed to create member: ${error.message}`);
  }
}
```

---

## ğŸ”Œ API ì‚¬ìš©ë²•

### Endpoint
```
POST http://localhost:3000/api/v1/auth/register
```

### Headers
```
Content-Type: application/json
```

### Request Body (ì „ì²´ í•„ë“œ)

```json
{
  "email": "hong@example.com",
  "password": "Password123!",
  "name": "í™ê¸¸ë™",
  "nickname": "ê¸¸ë™ì´",
  "phone": "010-1234-5678"
}
```

### Request Body (phone ìƒëµ)

```json
{
  "email": "kim@example.com",
  "password": "Password123!",
  "name": "ê¹€ì² ìˆ˜",
  "nickname": "ì² ìˆ˜"
}
```

### Response (201 Created)

```json
{
  "success": true,
  "message": "Registration successful",
  "data": {
    "member": {
      "member_id": 1,
      "member_email": "hong@example.com",
      "member_name": "í™ê¸¸ë™",
      "member_nickname": "ê¸¸ë™ì´",
      "member_phone": "010-1234-5678",
      "member_status": "active",
      "member_account_type": "email",
      "member_account_role": "buyer",
      "member_marketing_email": false,
      "member_marketing_sms": false,
      "member_created_at": "2025-10-02T02:00:00.000Z",
      "member_updated_at": "2025-10-02T02:00:00.000Z",
      "role": "buyer",
      "roles": ["buyer"]
    },
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
  }
}
```

---

## ğŸ“ í•„ë“œ ìƒì„¸ ì •ë³´

| í•„ë“œ | íƒ€ì… | í•„ìˆ˜ | ê²€ì¦ ê·œì¹™ | ì„¤ëª… |
|------|------|------|-----------|------|
| `email` | String | âœ… | ì´ë©”ì¼ í˜•ì‹, ìµœëŒ€ 255ì | íšŒì› ì´ë©”ì¼ |
| `password` | String | âœ… | ìµœì†Œ 8ì, ì˜ë¬¸+ìˆ«ì í¬í•¨ | ë¹„ë°€ë²ˆí˜¸ |
| `name` | String | âœ… | 2~30ì | **ì‹¤ëª…** |
| `nickname` | String | âœ… | 2~20ì, ì˜ë¬¸/ìˆ«ì/í•œê¸€ë§Œ ê°€ëŠ¥ | ë‹‰ë„¤ì„ (ê³ ìœ ) |
| `phone` | String | âŒ | 010-1234-5678 í˜•ì‹ | íœ´ëŒ€í° ë²ˆí˜¸ (ì„ íƒ) |

---

## âœ… ì²´í¬ë¦¬ìŠ¤íŠ¸

- [x] Prisma ìŠ¤í‚¤ë§ˆ ìˆ˜ì •
- [x] ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰ ë° ì ìš©
- [x] Validation ë¯¸ë“¤ì›¨ì–´ ì—…ë°ì´íŠ¸
- [x] Controller ìˆ˜ì •
- [x] Service ë¡œì§ ìˆ˜ì •
- [x] Repository ìˆ˜ì •
- [x] Prisma Client ì¬ìƒì„±
- [x] ì„œë²„ ì¬ì‹œì‘ ë° í…ŒìŠ¤íŠ¸

---

## ğŸš€ ë°°í¬ ì „ í™•ì¸ì‚¬í•­

1. **ë°ì´í„°ë² ì´ìŠ¤ ë°±ì—…**: í”„ë¡œë•ì…˜ ë°°í¬ ì „ ë°˜ë“œì‹œ ë°ì´í„°ë² ì´ìŠ¤ ë°±ì—… ìˆ˜í–‰
2. **ë§ˆì´ê·¸ë ˆì´ì…˜ ê²€ì¦**: ìŠ¤í…Œì´ì§• í™˜ê²½ì—ì„œ ë§ˆì´ê·¸ë ˆì´ì…˜ í…ŒìŠ¤íŠ¸
3. **ê¸°ì¡´ ë°ì´í„° ë§ˆì´ê·¸ë ˆì´ì…˜**: ê¸°ì¡´ íšŒì› ë°ì´í„°ì˜ `member_name` í•„ë“œ ì±„ìš°ê¸° í•„ìš”
4. **API ë¬¸ì„œ ì—…ë°ì´íŠ¸**: Swagger/Postman ë¬¸ì„œì— `name` í•„ë“œ ì¶”ê°€
5. **í”„ë¡ íŠ¸ì—”ë“œ ì—°ë™**: íšŒì›ê°€ì… í¼ì— ì´ë¦„ ì…ë ¥ë€ ì¶”ê°€

---

## ğŸ“š ì°¸ê³ ì‚¬í•­

- **member_account_type**: ê¸°ë³¸ê°’ "email", ì¶”í›„ "kakao", "naver" ë“± ì†Œì…œ ë¡œê·¸ì¸ ì§€ì› ì˜ˆì •
- **member_phone**: NULL í—ˆìš©, ì¶”í›„ íœ´ëŒ€í° ì¸ì¦ ê¸°ëŠ¥ ì¶”ê°€ ì‹œ í•„ìˆ˜ë¡œ ë³€ê²½ ê°€ëŠ¥
- **member_name vs member_nickname**: nameì€ ì‹¤ëª…, nicknameì€ ì„œë¹„ìŠ¤ ë‚´ í‘œì‹œëª…

---

---

## ğŸ”§ ì¶”ê°€ ë³€ê²½ì‚¬í•­ (2025-10-02 ì˜¤í›„)

### 1. `member_account_type` ê¸°ë³¸ê°’ ë³€ê²½

**ë³€ê²½ ì´ìœ **: ê³„ì • ìœ í˜•ì„ "email" â†’ "individual" (ê°œì¸ íšŒì›)ë¡œ ë³€ê²½

**íŒŒì¼**: `prisma/schema.prisma`

```prisma
// ë³€ê²½ ì „
member_account_type String @default("email") @db.VarChar(20)

// ë³€ê²½ í›„
member_account_type String @default("individual") @db.VarChar(20)
```

**ì ìš© ë°©ë²•**:
```bash
# Driftê°€ ìˆëŠ” ê²½ìš° db push ì‚¬ìš©
npx prisma db push
npx prisma generate
```

---

### 2. Supabase Pooler ì„¤ì • (Prepared Statement ì˜¤ë¥˜ í•´ê²°)

**ë¬¸ì œ**: PostgreSQL prepared statement ì˜¤ë¥˜ ë°œìƒ
```
Error: prepared statement "s0" already exists
```

**í•´ê²°**: DATABASE_URLì— `?pgbouncer=true` íŒŒë¼ë¯¸í„° ì¶”ê°€

**íŒŒì¼**: `.env`

```bash
# ë³€ê²½ ì „
DATABASE_URL=postgresql://postgres.ymqnpsiephgvdzzizsns:PASSWORD@aws-1-ap-northeast-2.pooler.supabase.com:6543/postgres

# ë³€ê²½ í›„
DATABASE_URL=postgresql://postgres.ymqnpsiephgvdzzizsns:PASSWORD@aws-1-ap-northeast-2.pooler.supabase.com:6543/postgres?pgbouncer=true
```

**ì°¸ê³ **: Supabaseì˜ Connection Poolerë¥¼ ì‚¬ìš©í•  ë•ŒëŠ” ë°˜ë“œì‹œ `?pgbouncer=true` íŒŒë¼ë¯¸í„°ê°€ í•„ìš”í•©ë‹ˆë‹¤.

---

### 3. MemberPermission Repository ìˆ˜ì •

**ë¬¸ì œ**: Prisma ëª¨ë¸ëª… ë° í•„ë“œëª… ë¶ˆì¼ì¹˜
- SchemaëŠ” `MemberPermission` ëª¨ë¸ì´ì§€ë§Œ ì½”ë“œì—ì„œ `member_permission` ì‚¬ìš©
- SchemaëŠ” `member_permission_role`ì´ `Int` íƒ€ì…ì´ì§€ë§Œ ì½”ë“œì—ì„œ String ì‚¬ìš©

**íŒŒì¼**: `src/repositories/memberPermission.repository.js`

#### ë³€ê²½ 1: Prisma ëª¨ë¸ëª… ìˆ˜ì •

```javascript
// ë³€ê²½ ì „ (ëª¨ë“  ê³³)
prisma.member_permission

// ë³€ê²½ í›„
prisma.memberPermission
```

#### ë³€ê²½ 2: í•„ë“œëª… ìˆ˜ì •

```javascript
// ë³€ê²½ ì „
permission_id               // PK
permission_role             // ì—­í• 
permission_created_at       // ìƒì„±ì¼

// ë³€ê²½ í›„
member_permission_id        // PK
member_permission_role      // ì—­í• 
member_permission_created_at // ìƒì„±ì¼
```

#### ë³€ê²½ 3: Role ë°ì´í„° íƒ€ì… ë³€í™˜ ë¡œì§ ì¶”ê°€

**Schema ì •ì˜**: `member_permission_role Int @default(1)`

**ì½”ë“œ ë§¤í•‘**: String â†’ Int ë³€í™˜ í•„ìš”

```javascript
// src/repositories/memberPermission.repository.js - create() í•¨ìˆ˜

async function create(permissionData) {
  try {
    // âœ… ì¶”ê°€: roleì„ ìˆ«ìë¡œ ë³€í™˜
    const roleMap = { 'buyer': 1, 'seller': 2, 'admin': 3 };
    const roleValue = roleMap[permissionData.permission_role] || 1;

    return await prisma.memberPermission.create({
      data: {
        member_id: BigInt(permissionData.member_id),
        member_permission_role: roleValue  // ìˆ«ìë¡œ ë³€í™˜í•˜ì—¬ ì €ì¥
      }
    });
  } catch (error) {
    if (error.code === 'P2002') {
      throw new Error('Permission already exists for this member');
    }
    throw new Error(`Failed to create permission: ${error.message}`);
  }
}
```

**ì—­í•  ë§¤í•‘**:
- `buyer` â†’ `1` (êµ¬ë§¤ì)
- `seller` â†’ `2` (íŒë§¤ì)
- `admin` â†’ `3` (ê´€ë¦¬ì)

---

### 4. ìˆ˜ì •ëœ íŒŒì¼ ëª©ë¡

1. âœ… `prisma/schema.prisma` - `member_account_type` ê¸°ë³¸ê°’ ë³€ê²½
2. âœ… `.env` - DATABASE_URLì— `?pgbouncer=true` ì¶”ê°€
3. âœ… `src/repositories/memberPermission.repository.js` - ëª¨ë¸ëª…/í•„ë“œëª…/íƒ€ì… ë³€í™˜ ìˆ˜ì •

---

### 5. íŠ¸ëŸ¬ë¸”ìŠˆíŒ… ìš”ì•½

| ë¬¸ì œ | ì›ì¸ | í•´ê²° ë°©ë²• |
|------|------|----------|
| Prepared statement ì˜¤ë¥˜ | Supabase Pooler ì‚¬ìš© ì‹œ pgbouncer íŒŒë¼ë¯¸í„° ëˆ„ë½ | DATABASE_URLì— `?pgbouncer=true` ì¶”ê°€ |
| `prisma.memberPermission` undefined | Prisma ëª¨ë¸ëª… snake_case ì‚¬ìš© | camelCaseë¡œ ë³€ê²½ (`memberPermission`) |
| Permission ìƒì„± ì‹¤íŒ¨ | í•„ë“œëª… ë¶ˆì¼ì¹˜ (`permission_role` vs `member_permission_role`) | Schema ê¸°ì¤€ìœ¼ë¡œ í•„ë“œëª… í†µì¼ |
| íƒ€ì… ì˜¤ë¥˜ | SchemaëŠ” Intì¸ë° String ì „ë‹¬ | Role mapping ë¡œì§ ì¶”ê°€ (String â†’ Int) |

---

**ì‘ì—… ì™„ë£Œì¼**: 2025-10-02
**ë§ˆì§€ë§‰ ìˆ˜ì •**: MemberPermission Repository ìˆ˜ì • ë° Supabase Pooler ì„¤ì • ì¶”ê°€
