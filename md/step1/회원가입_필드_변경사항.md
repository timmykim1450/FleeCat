# 회원가입 API 필드 변경사항

**작성일**: 2025-10-02
**작업 내용**: 회원가입 시 이름 필드 추가 및 스키마 수정

---

## 📋 변경 요약

회원가입 API에 **이름(name)** 필드를 필수로 추가하고, 휴대폰 번호는 선택사항으로 유지했습니다.

### 주요 변경사항
1. ✅ `member_name` 필드 추가 (필수)
2. ✅ `member_phone` 필드 선택사항으로 변경
3. ✅ `member_account_type` 기본값 "email" 설정
4. ✅ 테이블명 `members` → `member`로 변경

---

## 🗄️ 데이터베이스 스키마 변경

### 1. Prisma Schema 수정

**파일**: `prisma/schema.prisma`

```prisma
model Member {
  member_id              BigInt    @id @default(autoincrement())
  company_id             BigInt?
  member_email           String    @unique @db.VarChar(100)
  member_password        String?   @db.VarChar(255)
  member_name            String    @db.VarChar(30)           // ✅ 추가: 필수
  member_nickname        String    @unique @db.VarChar(30)
  member_phone           String?   @db.VarChar(15)           // ✅ 변경: 선택사항 (String?)
  member_account_type    String    @default("email") @db.VarChar(20) // ✅ 기본값 추가
  member_account_role    String    @default("buyer") @db.VarChar(20)
  member_status          String    @default("active") @db.VarChar(20)
  member_marketing_email Boolean   @default(false)
  member_marketing_sms   Boolean   @default(false)
  member_last_login_at   DateTime?
  member_created_at      DateTime  @default(now())
  member_updated_at      DateTime  @default(now()) @updatedAt

  @@map("member")  // ✅ 테이블명 변경: members → member
}
```

### 2. 마이그레이션 실행

```bash
# 1차 마이그레이션: 테이블명 변경
npx prisma migrate dev --name rename_members_to_member

# 2차 마이그레이션: 필드 추가/수정
npx prisma migrate dev --name add_name_and_optional_phone
```

**생성된 마이그레이션 파일**:
- `20251002015915_rename_members_to_member/migration.sql`
- `20251002021051_add_name_and_optional_phone/migration.sql`

---

## 💻 코드 변경사항

### 1. Validation 미들웨어

**파일**: `src/middlewares/validation.js`

```javascript
const validateRegister = [
  body('email')
    .notEmpty()
    .withMessage('Email is required')
    .isEmail()
    .withMessage('Invalid email format')
    .isLength({ max: 255 })
    .withMessage('Email must not exceed 255 characters')
    .normalizeEmail(),

  body('password')
    .notEmpty()
    .withMessage('Password is required')
    .isLength({ min: 8 })
    .withMessage('Password must be at least 8 characters')
    .matches(/^(?=.*[A-Za-z])(?=.*\d)/)
    .withMessage('Password must contain at least one letter and one number'),

  // ✅ 추가: name 필드 검증
  body('name')
    .notEmpty()
    .withMessage('Name is required')
    .isLength({ min: 2, max: 30 })
    .withMessage('Name must be between 2 and 30 characters')
    .trim(),

  body('nickname')
    .notEmpty()
    .withMessage('Nickname is required')
    .isLength({ min: 2, max: 20 })
    .withMessage('Nickname must be between 2 and 20 characters')
    .matches(/^[a-zA-Z0-9가-힣]+$/)
    .withMessage('Nickname can only contain letters, numbers, and Korean characters')
    .trim(),

  body('phone')
    .optional({ checkFalsy: true })  // ✅ 유지: 선택사항
    .matches(/^01[0-9]-?[0-9]{3,4}-?[0-9]{4}$/)
    .withMessage('Invalid phone number format (e.g., 010-1234-5678 or 01012345678)')
    .trim(),

  handleValidationErrors
];
```

### 2. Controller

**파일**: `src/controllers/auth.controller.js`

```javascript
async function register(req, res, next) {
  try {
    // ✅ 추가: name 파라미터 추출
    const { email, password, name, nickname, phone } = req.body;

    const result = await authService.register({
      email,
      password,
      name,      // ✅ 추가
      nickname,
      phone
    });

    return successResponse(res, result, 'Registration successful', 201);
  } catch (error) {
    next(error);
  }
}
```

### 3. Service

**파일**: `src/services/auth.service.js`

```javascript
async function register(data) {
  const { email, password, name, nickname, phone } = data;  // ✅ name 추가

  // 1. 이메일 중복 확인
  const emailExists = await memberRepository.existsByEmail(email);
  if (emailExists) {
    throw new ValidationError('Email already exists');
  }

  // 2. 닉네임 중복 확인
  const nicknameExists = await memberRepository.existsByNickname(nickname);
  if (nicknameExists) {
    throw new ValidationError('Nickname already exists');
  }

  // 3. 비밀번호 해싱
  const hashedPassword = await bcrypt.hash(password, 10);

  // 4. 회원 생성
  const member = await memberRepository.create({
    member_email: email,
    member_password: hashedPassword,
    member_name: name,          // ✅ 추가
    member_nickname: nickname,
    member_phone: phone || null,
    member_status: 'active'
  });

  // ... 권한 부여 및 토큰 생성
}
```

### 4. Repository

**파일**: `src/repositories/member.repository.js`

```javascript
async function create(memberData) {
  try {
    return await prisma.member.create({
      data: {
        member_email: memberData.member_email,
        member_password: memberData.member_password,
        member_name: memberData.member_name,          // ✅ 추가
        member_nickname: memberData.member_nickname,
        member_phone: memberData.member_phone || null,
        member_status: memberData.member_status || 'active',
        company_id: memberData.company_id ? BigInt(memberData.company_id) : null
      }
    });
  } catch (error) {
    throw new Error(`Failed to create member: ${error.message}`);
  }
}
```

---

## 🔌 API 사용법

### Endpoint
```
POST http://localhost:3000/api/v1/auth/register
```

### Headers
```
Content-Type: application/json
```

### Request Body (전체 필드)

```json
{
  "email": "hong@example.com",
  "password": "Password123!",
  "name": "홍길동",
  "nickname": "길동이",
  "phone": "010-1234-5678"
}
```

### Request Body (phone 생략)

```json
{
  "email": "kim@example.com",
  "password": "Password123!",
  "name": "김철수",
  "nickname": "철수"
}
```

### Response (201 Created)

```json
{
  "success": true,
  "message": "Registration successful",
  "data": {
    "member": {
      "member_id": 1,
      "member_email": "hong@example.com",
      "member_name": "홍길동",
      "member_nickname": "길동이",
      "member_phone": "010-1234-5678",
      "member_status": "active",
      "member_account_type": "email",
      "member_account_role": "buyer",
      "member_marketing_email": false,
      "member_marketing_sms": false,
      "member_created_at": "2025-10-02T02:00:00.000Z",
      "member_updated_at": "2025-10-02T02:00:00.000Z",
      "role": "buyer",
      "roles": ["buyer"]
    },
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
  }
}
```

---

## 📝 필드 상세 정보

| 필드 | 타입 | 필수 | 검증 규칙 | 설명 |
|------|------|------|-----------|------|
| `email` | String | ✅ | 이메일 형식, 최대 255자 | 회원 이메일 |
| `password` | String | ✅ | 최소 8자, 영문+숫자 포함 | 비밀번호 |
| `name` | String | ✅ | 2~30자 | **실명** |
| `nickname` | String | ✅ | 2~20자, 영문/숫자/한글만 가능 | 닉네임 (고유) |
| `phone` | String | ❌ | 010-1234-5678 형식 | 휴대폰 번호 (선택) |

---

## ✅ 체크리스트

- [x] Prisma 스키마 수정
- [x] 마이그레이션 실행 및 적용
- [x] Validation 미들웨어 업데이트
- [x] Controller 수정
- [x] Service 로직 수정
- [x] Repository 수정
- [x] Prisma Client 재생성
- [x] 서버 재시작 및 테스트

---

## 🚀 배포 전 확인사항

1. **데이터베이스 백업**: 프로덕션 배포 전 반드시 데이터베이스 백업 수행
2. **마이그레이션 검증**: 스테이징 환경에서 마이그레이션 테스트
3. **기존 데이터 마이그레이션**: 기존 회원 데이터의 `member_name` 필드 채우기 필요
4. **API 문서 업데이트**: Swagger/Postman 문서에 `name` 필드 추가
5. **프론트엔드 연동**: 회원가입 폼에 이름 입력란 추가

---

## 📚 참고사항

- **member_account_type**: 기본값 "email", 추후 "kakao", "naver" 등 소셜 로그인 지원 예정
- **member_phone**: NULL 허용, 추후 휴대폰 인증 기능 추가 시 필수로 변경 가능
- **member_name vs member_nickname**: name은 실명, nickname은 서비스 내 표시명

---

---

## 🔧 추가 변경사항 (2025-10-02 오후)

### 1. `member_account_type` 기본값 변경

**변경 이유**: 계정 유형을 "email" → "individual" (개인 회원)로 변경

**파일**: `prisma/schema.prisma`

```prisma
// 변경 전
member_account_type String @default("email") @db.VarChar(20)

// 변경 후
member_account_type String @default("individual") @db.VarChar(20)
```

**적용 방법**:
```bash
# Drift가 있는 경우 db push 사용
npx prisma db push
npx prisma generate
```

---

### 2. Supabase Pooler 설정 (Prepared Statement 오류 해결)

**문제**: PostgreSQL prepared statement 오류 발생
```
Error: prepared statement "s0" already exists
```

**해결**: DATABASE_URL에 `?pgbouncer=true` 파라미터 추가

**파일**: `.env`

```bash
# 변경 전
DATABASE_URL=postgresql://postgres.ymqnpsiephgvdzzizsns:PASSWORD@aws-1-ap-northeast-2.pooler.supabase.com:6543/postgres

# 변경 후
DATABASE_URL=postgresql://postgres.ymqnpsiephgvdzzizsns:PASSWORD@aws-1-ap-northeast-2.pooler.supabase.com:6543/postgres?pgbouncer=true
```

**참고**: Supabase의 Connection Pooler를 사용할 때는 반드시 `?pgbouncer=true` 파라미터가 필요합니다.

---

### 3. MemberPermission Repository 수정

**문제**: Prisma 모델명 및 필드명 불일치
- Schema는 `MemberPermission` 모델이지만 코드에서 `member_permission` 사용
- Schema는 `member_permission_role`이 `Int` 타입이지만 코드에서 String 사용

**파일**: `src/repositories/memberPermission.repository.js`

#### 변경 1: Prisma 모델명 수정

```javascript
// 변경 전 (모든 곳)
prisma.member_permission

// 변경 후
prisma.memberPermission
```

#### 변경 2: 필드명 수정

```javascript
// 변경 전
permission_id               // PK
permission_role             // 역할
permission_created_at       // 생성일

// 변경 후
member_permission_id        // PK
member_permission_role      // 역할
member_permission_created_at // 생성일
```

#### 변경 3: Role 데이터 타입 변환 로직 추가

**Schema 정의**: `member_permission_role Int @default(1)`

**코드 매핑**: String → Int 변환 필요

```javascript
// src/repositories/memberPermission.repository.js - create() 함수

async function create(permissionData) {
  try {
    // ✅ 추가: role을 숫자로 변환
    const roleMap = { 'buyer': 1, 'seller': 2, 'admin': 3 };
    const roleValue = roleMap[permissionData.permission_role] || 1;

    return await prisma.memberPermission.create({
      data: {
        member_id: BigInt(permissionData.member_id),
        member_permission_role: roleValue  // 숫자로 변환하여 저장
      }
    });
  } catch (error) {
    if (error.code === 'P2002') {
      throw new Error('Permission already exists for this member');
    }
    throw new Error(`Failed to create permission: ${error.message}`);
  }
}
```

**역할 매핑**:
- `buyer` → `1` (구매자)
- `seller` → `2` (판매자)
- `admin` → `3` (관리자)

---

### 4. 수정된 파일 목록

1. ✅ `prisma/schema.prisma` - `member_account_type` 기본값 변경
2. ✅ `.env` - DATABASE_URL에 `?pgbouncer=true` 추가
3. ✅ `src/repositories/memberPermission.repository.js` - 모델명/필드명/타입 변환 수정

---

### 5. 트러블슈팅 요약

| 문제 | 원인 | 해결 방법 |
|------|------|----------|
| Prepared statement 오류 | Supabase Pooler 사용 시 pgbouncer 파라미터 누락 | DATABASE_URL에 `?pgbouncer=true` 추가 |
| `prisma.memberPermission` undefined | Prisma 모델명 snake_case 사용 | camelCase로 변경 (`memberPermission`) |
| Permission 생성 실패 | 필드명 불일치 (`permission_role` vs `member_permission_role`) | Schema 기준으로 필드명 통일 |
| 타입 오류 | Schema는 Int인데 String 전달 | Role mapping 로직 추가 (String → Int) |

---

**작업 완료일**: 2025-10-02
**마지막 수정**: MemberPermission Repository 수정 및 Supabase Pooler 설정 추가
